<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport"/>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type"/>

    <title>Bragi - Chapter</title>

    <!-- Required Stylesheets -->
    <link
            href="https://unpkg.com/bootstrap@4.5/dist/css/bootstrap.min.css"
            rel="stylesheet"
            type="text/css"
    />
    <link
            href="https://unpkg.com/bootstrap-vue@2.15/dist/bootstrap-vue.css"
            rel="stylesheet"
            type="text/css"
    />

    <!-- Load polyfills to support older browsers -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es2015%2CIntersectionObserver"></script>

    <!-- Required scripts -->
    <script src="https://unpkg.com/vue@2.6/dist/vue.js"></script>
    <script src="https://unpkg.com/bootstrap-vue@2.15/dist/bootstrap-vue.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.js"></script>
</head>
<body>
<!-- Our application root element -->
<div id="app">
    <b-container>
        <!-- Navigation -->
        <b-navbar toggleable="lg" type="dark" variant="info">
            <b-navbar-brand href="#">Bragi</b-navbar-brand>

            <b-navbar-toggle target="nav-collapse"></b-navbar-toggle>

            <b-collapse id="nav-collapse" is-nav>
                <b-navbar-nav>
                    <b-nav-item href="chapters.html">Chapters</b-nav-item>
                    <b-nav-item href="characters.html">Characters</b-nav-item>
                </b-navbar-nav>
            </b-collapse>
        </b-navbar>
        <!-- /Navigation -->

        <b-jumbotron header="Chapter">
            It has the ID {{ chapter.id }}, was created on {{ chapter.createdOn }} and last modified on {{
            chapter.lastModified }}.
        </b-jumbotron>


        <b-form @submit="onSubmit">
            <b-form-group id="input-group-title" label="Title" label-for="input-title">
                <b-form-input
                        id="input-title"
                        placeholder="Enter title"
                        required
                        v-model="chapter.title"
                ></b-form-input>
            </b-form-group>

            <b-form-group id="input-group-content" label="Content" label-for="input-content">
                <b-form-textarea
                        id="input-content"
                        max-rows="20"
                        placeholder="Here should be your pretty story"
                        rows="10"
                        v-model="chapter.content"
                ></b-form-textarea>
            </b-form-group>

            <b-form-group id="input-group-summary" label="Summary" label-for="input-summary">
                <b-form-textarea
                        id="input-summary"
                        max-rows="20"
                        placeholder="Here should be your summary"
                        rows="5"
                        v-model="chapter.summary"
                ></b-form-textarea>
            </b-form-group>

            <b-form-group id="input-group-notes" label="Notes" label-for="input-notes">
                <b-form-textarea
                        id="input-notes"
                        max-rows="20"
                        placeholder="Here should be your notes"
                        rows="5"
                        v-model="chapter.notes"
                ></b-form-textarea>
            </b-form-group>

            <b-button type="submit" variant="primary">Update chapter</b-button>
        </b-form>

        <!--        <b-card class="mt-3" header="Form Data Result">-->
        <!--            <pre class="m-0">{{ form }}</pre>-->
        <!--        </b-card>-->

        <h2>Suggested characters</h2>
        <table class="table table-sm table-hover">
            <thead class="thead-light">
            <th>Name</th>
            <!--            <th>ID</th> -->
            <th>Show Notes</th>
            </thead>
            <tbody>
            <tr
                    is="character-item"
                    v-bind:character="item"
                    v-bind:key="item.id"
                    v-for="item in suggestedCharacters"
            ></tr>
            </tbody>
        </table>

        <b-popover :key="item.id" placement="top" target="popover-target-1" triggers="hover"
                   v-bind:target="'popover-target-' + item.id" v-for="item in suggestedCharacters">
            <template v-slot:title>{{ item.name }}</template>
            {{ item.notes }}
        </b-popover>

    </b-container>
</div>

<!-- Start running your app -->
<script>
    Vue.component("character-item", {
        props: ["character"],
        template: `
               <tr>
                 <td>
                   <a v-bind:href="'character.html?id=' + character.id">{{ character.name }}</a>
                 </td>
<!--                 <td>{{ character.id }}</td> -->
                <td>
                    <b-button v-bind:id="'popover-target-' + character.id">
                        Hover Me
                      </b-button>
                </td>
               </tr>
            `,
      });

      var vm = new Vue({
        el: '#app',
        data: {
            chapterId: null,
            chapter: { "id": 12, "title": "blubb", "content": "blubbb blubb <b>bold</b>", "summary": "sum sum summary", "notes": "saddsads", suggestedCharacters: [121, 122] },
            suggestedCharacters : [
                { "id": 121, "name": "Arya", "notes": "Little girl" },
                { "id": 122, "name": "Jon", "notes": "Bearded guy" },
             ],
            form: {
              title: '',
              content: '',
            },
        },
        mounted() {
          axios
            .get("http://localhost:8080/chapters/"+this.chapterId)
            .then((chapterResponse) => {
                  this.chapter = chapterResponse.data;

                  // get all suggested characters
                  this.suggestedCharacters = [];
                  for (suggestedCharacterId of this.chapter.suggestedCharacters) {
                    axios
                      .get("http://localhost:8080/characters/"+suggestedCharacterId)
                      .then((characterResponse) => (
                        this.suggestedCharacters.push(characterResponse.data)
                      ));
                  }
                }
            );
        },
        created()
        {
          let uri = window.location.search.substring(1);
          let params = new URLSearchParams(uri);
          console.log(params.get("id"));
          this.chapterId = params.get("id");
        },
        methods: {
          onSubmit(evt) {
            evt.preventDefault()
            //alert(JSON.stringify(this.form))
            axios
              .put("http://localhost:8080/chapters/"+this.chapter.id, { title: this.chapter.title, content: this.chapter.content, summary: this.chapter.summary, notes: this.chapter.notes })
              .then((chapterResponse) => {
                this.chapter = chapterResponse.data;

                  // get all suggested characters
                  this.suggestedCharacters = [];
                  for (suggestedCharacterId of this.chapter.suggestedCharacters) {
                    axios
                      .get("http://localhost:8080/characters/"+suggestedCharacterId)
                      .then((characterResponse) => (
                        this.suggestedCharacters.push(characterResponse.data)
                      ));
                  }
              }
            );
          },
        }
      })



</script>
</body>
</html>